<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SMARTEDU</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
</head>
<body>
  <h2>Subir PDF</h2>
  <input type="file" id="pdfInput" accept="application/pdf">
  <button id="guardar">GUARDAR</button>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

// Función para generar UUID
function generarUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

document.getElementById('guardar').addEventListener('click', async () => {
  const file = document.getElementById('pdfInput').files[0];
  if (!file) {
    alert('Selecciona un PDF primero.');
    return;
  }

  try {
    const arrayBuffer = await file.arrayBuffer();
    const pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
    let textoCompleto = '';

    for (let i = 1; i <= pdfDoc.numPages; i++) {
      const page = await pdfDoc.getPage(i);
      const content = await page.getTextContent();
      const strings = content.items.map(item => item.str.trim()).filter(s => s.length > 0);
      textoCompleto += strings.join(' ') + ' ';
    }

    const bloques = textoCompleto.split(/(?=\d{5}\s[A-Z]{4,})/g).map(b => b.trim()).filter(b => b.length > 0);
    const horarios = [];

    const regex = /(\d{5})\s+([A-Z]{4,})\s+(\d{3})\s+([A-Za-zÁÉÍÓÚÜÑ.\s]+?)\s+(OO\d|[A-Z]{2}\d?)\s+([A-Z])\s+(\d{4})\s*-\s*(\d{4})\s+([A-ZÁÉÍÓÚÜÑ.\-\s]+?)\s+(\w+\/\d+)/;

    for (const bloque of bloques) {
      const match = bloque.match(regex);
      if (match) {
        horarios.push({
          NRC: match[1],
          Clave: `${match[2]} ${match[3]}`,
          Materia: match[4].trim(),
          Secc: match[5],
          Días: match[6],
          Hora: `${match[7]}-${match[8]}`,
          Profesor: match[9].trim(),
          Salón: match[10]
        });
      }
    }

    if (horarios.length === 0) {
      alert("No se detectaron registros válidos.");
      return;
    }

    const session_id = generarUUID();
    console.log("Session ID generado:", session_id);

    const response = await fetch('database.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ horarios, session_id })
    });

    const result = await response.text();
    alert(result);
    console.log("Respuesta del servidor:", result);

  } catch (error) {
    console.error("Error al procesar:", error);
    alert("Error al guardar los datos.");
  }
});
</script>
</body>
</html>
