<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SMARTEDU</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
</head>
<body>
  <h2>Subir PDF</h2>
  <input type="file" id="pdfInput" accept="application/pdf">
  <button id="guardar">GUARDAR </button>

 <script>
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

document.getElementById('guardar').addEventListener('click', async () => {   // Manejar clic en el botón "GUARDAR"
  const file = document.getElementById('pdfInput').files[0];  // Obtener el archivo PDF seleccionado
  if (!file) {
    alert('Selecciona un PDF primero.');
    return; 
  }

  try {
    const arrayBuffer = await file.arrayBuffer(); // Lee el archivo como ArrayBuffer lo q esdpera pdf.js
    const pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise; // Cargar el PDF
    let textoCompleto = ''; 

    // Extra  texto de todas las páginas
    for (let i = 1; i <= pdfDoc.numPages; i++) {
      const page = await pdfDoc.getPage(i);
      const content = await page.getTextContent();
      const strings = content.items.map(item => item.str.trim()).filter(s => s.length > 0); // Filtra cadenas vacías
      textoCompleto += strings.join(' ') + ' ';
    }

    console.log("Texto extraído:", textoCompleto.slice(0, 800)); 
//la primer linea q detecta en este caso NRC las filtra y gorda por nrc 
    const bloques = textoCompleto.split(/(?=\d{5}\s[A-Z]{4,})/g).map(b => b.trim()).filter(b => b.length > 0);
    console.log("Bloques detectados:", bloques.length);

    const horarios = [];

    // extrae tomando de referencia el nrc todos los demas datos 
    const regex = /(\d{5})\s+([A-Z]{4,})\s+(\d{3})\s+([A-Za-zÁÉÍÓÚÜÑ.\s]+?)\s+(OO\d|[A-Z]{2}\d?)\s+([A-Z])\s+(\d{4})\s*-\s*(\d{4})\s+([A-ZÁÉÍÓÚÜÑ.\-\s]+?)\s+(\w+\/\d+)/;
//por cada extraccion hace un bloque 
    for (const bloque of bloques) {
      const match = bloque.match(regex);
      if (match) {
        horarios.push({
          NRC: match[1],
          Clave: `${match[2]} ${match[3]}`,
          Materia: match[4].trim(),
          Secc: match[5],
          Días: match[6],
          Hora: `${match[7]}-${match[8]}`,
          Profesor: match[9].trim(),
          Salón: match[10]
        });
      }
    }

    console.log("Horarios detectados:", horarios);

    if (horarios.length === 0) {
      alert("No se detectaron registros válidos.");
      return;
    }
//coneccion con el php para guardar en la base de datos
    const response = await fetch('database.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ horarios })
    });

    const result = await response.text();
    alert(result);
    console.log("Respuesta del servidor:", result);

  } catch (error) {
    console.error("Error al procesar:", error);
    alert("Error al  guardar los datos.");
  }
});
</script>

</body>
</html>
